/**
 * Copyright (c) 2007-2014 Kaazing Corporation. All rights reserved.
 * 
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
function URI(a){a=a||"";var b=0,c=a.indexOf("://");if(-1!=c){this.scheme=a.slice(0,c),b=c+3;var d=a.indexOf("/",b);-1==d&&(d=a.length,a+="/");var e=a.slice(b,d);this.authority=e,b=d,this.host=e;var f=e.indexOf(":");if(-1!=f&&(this.host=e.slice(0,f),this.port=parseInt(e.slice(f+1),10),isNaN(this.port)))throw new Error("Invalid URI syntax")}var g=a.indexOf("?",b);-1!=g&&(this.path=a.slice(b,g),b=g+1);var h=a.indexOf("#",b);-1!=h?(-1!=g?this.query=a.slice(b,h):this.path=a.slice(b,h),b=h+1,this.fragment=a.slice(b)):-1!=g?this.query=a.slice(b):this.path=a.slice(b)}var browser=null;if("undefined"!=typeof ActiveXObject)browser=-1!=navigator.userAgent.indexOf("MSIE 10")?"chrome":"ie";else if(-1!=navigator.userAgent.indexOf("Trident/7")&&-1!=navigator.userAgent.indexOf("rv:11"))browser="chrome";else if(-1!=navigator.userAgent.indexOf("Edge"))browser="chrome";else if("[object Opera]"==Object.prototype.toString.call(window.opera))browser="opera";else if(-1!=navigator.vendor.indexOf("Apple"))browser="safari",-1==navigator.userAgent.indexOf("iPad")&&-1==navigator.userAgent.indexOf("iPhone")||(browser.ios=!0);else if(-1!=navigator.vendor.indexOf("Google"))browser=-1!=navigator.userAgent.indexOf("Android")&&-1==navigator.userAgent.indexOf("Chrome")?"android":"chrome";else{if("Gecko"!=navigator.product||!window.find||navigator.savePreferences)throw new Error("couldn't detect browser");browser="firefox"}switch(browser){case"ie":!function(){function a(a,b,c,d){if(d)throw new Error("Not implemented");var e=a[b]||{};a[b]=e,e[c]=c}function b(a,b,c,d){if(d)throw new Error("Not implemented");var e=a[b]||{};delete e[c]}function c(a,b){var c=b.type,d=a[c]||{};for(var e in d)if(d.hasOwnProperty(e)&&"function"==typeof d[e])try{d[e](b)}catch(f){}}if(void 0===document.createEvent){var d=function(){};d.prototype.initEvent=function(a,b,c){this.type=a,this.bubbles=b,this.cancelable=c},document.createEvent=function(a){if("Events"!=a)throw new Error("Unsupported event name: "+a);return new d}}if(document._w_3_c_d_o_m_e_v_e_n_t_s_createElement=document.createElement,document.createElement=function(d){var e=this._w_3_c_d_o_m_e_v_e_n_t_s_createElement(d);if(void 0===e.addEventListener){var f={};e.addEventListener=function(b,c,d){return e.attachEvent("on"+b,c),a(f,b,c,d)},e.removeEventListener=function(a,c,d){return b(f,a,c,d)},e.dispatchEvent=function(a){return c(f,a)}}return e},void 0===window.addEventListener){var e=document.createElement("div"),f="undefined"==typeof postMessage;window.addEventListener=function(a,b,c){f&&"message"==a?e.addEventListener(a,b,c):window.attachEvent("on"+a,b)},window.removeEventListener=function(a,b,c){f&&"message"==a?e.removeEventListener(a,b,c):window.detachEvent("on"+a,b)},window.dispatchEvent=function(a){f&&"message"==a.type?e.dispatchEvent(a):window.fireEvent("on"+a.type,a)}}}();break;case"chrome":case"android":case"safari":if("undefined"==typeof window.postMessage&&"undefined"==typeof window.dispatchEvent&&"function"==typeof document.dispatchEvent){window.dispatchEvent=function(a){document.dispatchEvent(a)};var addEventListener0=window.addEventListener;window.addEventListener=function(a,b,c){"message"===a?document.addEventListener(a,b,c):addEventListener0.call(window,a,b,c)};var removeEventListener0=window.removeEventListener;window.removeEventListener=function(a,b,c){"message"===a?document.removeEventListener(a,b,c):removeEventListener0.call(window,a,b,c)}}break;case"opera":var addEventListener0=window.addEventListener;window.addEventListener=function(a,b,c){var d=b;"message"===a&&(d=function(a){if(void 0===a.origin&&void 0!==a.uri){var c=new URI(a.uri);delete c.path,delete c.query,delete c.fragment,a.origin=c.toString()}return b(a)},b._$=d),addEventListener0.call(window,a,d,c)};var removeEventListener0=window.removeEventListener;window.removeEventListener=function(a,b,c){var d=b;"message"===a&&(d=b._$),removeEventListener0.call(window,a,d,c)}}!function(){var a=URI.prototype;a.toString=function(){var a=[],b=this.scheme;if(void 0!==b){a.push(b),a.push("://"),a.push(this.host);var c=this.port;void 0!==c&&(a.push(":"),a.push(c.toString()))}return void 0!==this.path&&a.push(this.path),void 0!==this.query&&(a.push("?"),a.push(this.query)),void 0!==this.fragment&&(a.push("#"),a.push(this.fragment)),a.join("")};var b={http:80,ws:80,https:443,wss:443};URI.replaceProtocol=function(a,b){var c=a.indexOf("://");return c>0?b+a.substr(c):""}}();var postMessage0=function(){function a(a){this.sourceToken=g(Math.floor(Math.random()*(Math.pow(2,32)-1)),8),this.iframe=a,this.bridged=!1,this.lastWrite=0,this.lastRead=0,this.lastReadIndex=2,this.lastSyn=0,this.lastAck=0,this.queue=[],this.escapedFragments=[]}function b(){var a=this.reader.location.hash;this._lastHash!=a&&(i(this,a.substring(1)),this._lastHash=a)}function c(){var a=this.reader.document.URL;if(this._lastDocumentURL!=a){var b=a.indexOf("#");-1!=b&&(i(this,a.substring(b+1)),this._lastDocumentURL=a)}}function d(a,b){if(a.lastWrite<1&&!a.bridged&&b.parent==window){for(var c=a.iframe.src,d=c.split("#"),e=null,f=document.getElementsByTagName("meta"),g=0;g<f.length;g++)"kaazing:resources"==f[g].name&&alert('kaazing:resources is no longer supported. Please refer to the Administrator\'s Guide section entitled "Configuring a Web Server to Integrate with Kaazing Gateway"');var h=r,i=h.toString()+s+"?.kr=xsp&.kv=10.05";if(e){var j=new URI(h.toString()),d=e.split(":");j.host=d.shift(),d.length&&(j.port=d.shift()),i=j.toString()+s+"?.kr=xsp&.kv=10.05"}for(var g=0;g<f.length;g++)if("kaazing:postMessageBridgeURL"==f[g].name){var k=f[g].content,l=new URI(k),m=new URI(location.toString());if(!l.authority&&(l.host=m.host,l.port=m.port,l.scheme=m.scheme,0!=k.indexOf("/"))){var o=m.path.split("/");o.pop(),o.push(k),l.path=o.join("/")}n.BridgeURL=l.toString()}n.BridgeURL&&(i=n.BridgeURL);var p=["I",h,a.sourceToken,escape(i)];if(d.length>1){var q=d[1];p.push(escape(q))}d[1]=p.join("!"),setTimeout(function(){b.location.replace(d.join("#"))},200),a.bridged=!0}}function e(a,b){var c=a.writerURL+"#"+b;a.writer.location.replace(c)}function f(a){return parseInt(a,16)}function g(a,b){var c=a.toString(16),d=[];for(b-=c.length;b-- >0;)d.push("0");return d.push(c),d.join("")}function h(a,b){var c=a.queue,d=a.lastRead;if((c.length>0||b)&&a.lastSyn>a.lastAck){var h=a.lastFrames,i=a.lastReadIndex;f(h[i])!=d&&(h[i]=g(d,8),e(a,h.join("")))}else if(c.length>0){var j=c.shift(),k=j[0];if("*"==k||k==a.targetOrigin){a.lastWrite++;var l=j[1],m=l.shift(),n=3,h=[a.targetToken,g(a.lastWrite,8),g(d,8),"F",g(m.length,4),m],i=2;if(l.length>0&&(h[n]="f",a.queue.unshift(j)),a.resendAck){var o=[a.targetToken,g(a.lastWrite-1,8),g(d,8),"a"];h=o.concat(h),i+=o.length}e(a,h.join("")),a.lastFrames=h,a.lastReadIndex=i,a.lastSyn=a.lastWrite,a.resendAck=!1}}else if(b){a.lastWrite++;var h=[a.targetToken,g(a.lastWrite,8),g(d,8),"a"],i=2;if(a.resendAck){var o=[a.targetToken,g(a.lastWrite-1,8),g(d,8),"a"];h=o.concat(h),i+=o.length}e(a,h.join("")),a.lastFrames=h,a.lastReadIndex=i,a.resendAck=!0}}function i(a,b){var c=b.substring(0,8),d=f(b.substring(8,16)),e=f(b.substring(16,24)),g=b.charAt(24);if(c!=a.sourceToken)throw new Error("postMessage emulation tampering detected");var k=a.lastRead,l=k+1;if(d==l&&(a.lastRead=l),d!=l&&d!=k||(a.lastAck=e),d==l||d==k&&"a"==g)switch(g){case"f":var m=b.substr(29,f(b.substring(25,29)));a.escapedFragments.push(m),h(a,!0);break;case"F":var n=b.substr(29,f(b.substring(25,29)));void 0!==a.escapedFragments&&(a.escapedFragments.push(n),n=a.escapedFragments.join(""),a.escapedFragments=[]);var o=unescape(n);j(o,a.target,a.targetOrigin),h(a,!0);break;case"a":b.length>25?i(a,b.substring(25)):h(a,!1);break;default:throw new Error("unknown postMessage emulation payload type: "+g)}}function j(a,b,c){var d=document.createEvent("Events");d.initEvent("message",!1,!0),d.data=a,d.origin=c,d.source=b,dispatchEvent(d)}function k(){for(var a=0,b=v.length;b>a;a++){var c=v[a];c.poll()}setTimeout(k,20)}function l(a){if(a==parent)return u.parent;if(a.parent!=window)throw new Error("Generic peer postMessage not yet implemented");for(var b=document.getElementsByTagName("iframe"),c=0;c<b.length;c++){var d=b[c];if(a==d.contentWindow)return m(d)}}function m(b){var c=b._name;void 0===c&&(c="iframe$"+String(Math.random()).substring(2),b._name=c);var d=u[c];return void 0===d&&(d=new a(b),u[c]=d),d}function n(a,b,c){if("string"!=typeof b)throw new Error("Unsupported type. Messages must be strings");if(a==window)"*"!=c&&c!=r||j(b,window,r);else{var d=l(a);d.post(a,b,c)}}function o(){var a=new URI("ie"==browser?document.URL:location.href),b=a.fragment||"";if(null!=document.body&&b.length>0&&"I"==b.charAt(0)){var c=unescape(b),d=c.split("!");if("I"==d.shift()){var e=d.shift(),f=d.shift(),g=unescape(d.shift()),h=r;if(e==h)try{parent.location.hash}catch(i){document.domain=document.domain}var j=d.shift()||"";switch(browser){case"firefox":location.replace([location.href.split("#")[0],j].join("#"));break;default:location.hash=j}var k=l(parent);k.targetToken=f;var m=k.sourceToken,n=g+"#"+escape([h,f,m].join(",")),p;return p=document.createElement("iframe"),p.src=n,p.style.position="absolute",p.style.left="-10px",p.style.top="10px",p.style.visibility="hidden",p.style.width="0px",p.style.height="0px",void document.body.appendChild(p)}}setTimeout(o,20)}var p=new URI("ie"==browser?document.URL:location.href),q={http:80,https:443};null==p.port&&(p.port=q[p.scheme],p.authority=p.host+":"+p.port);var r=p.scheme+"://"+p.authority,s="/.kr";if("undefined"!=typeof postMessage)return function(a,b,c){if("string"!=typeof b)throw new Error("Unsupported type. Messages must be strings");switch("null"===c&&(c="*"),browser){case"ie":case"opera":case"firefox":setTimeout(function(){a.postMessage(b,c)},0);break;default:a.postMessage(b,c)}};var t=a.prototype;t.attach=function(a,d,e,f,g,i){this.target=a,this.targetOrigin=d,this.targetToken=e,this.reader=f,this.writer=g,this.writerURL=i;try{this._lastHash=f.location.hash,this.poll=b}catch(j){this._lastDocumentURL=f.document.URL,this.poll=c}a==parent&&h(this,!0)},t.detach=function(){this.poll=function(){},delete this.target,delete this.targetOrigin,delete this.reader,delete this.lastFragment,delete this.writer,delete this.writerURL},t.poll=function(){},t.post=function(a,b,c){d(this,a);for(var e=1e3,f=escape(b),g=[];f.length>e;){var i=f.substring(0,e);f=f.substring(e),g.push(i)}g.push(f),this.queue.push([c,g]),null!=this.writer&&this.lastAck>=this.lastSyn&&h(this,!1)};var u={},v=[];n.attach=function(a,b,c,d,e,f){var g=l(a);g.attach(a,b,c,d,e,f),v.push(g)};var w=function(a){var b=new URI("ie"==browser?document.URL:location.href),c,d={http:80,https:443};null==b.port&&(b.port=d[b.scheme],b.authority=b.host+":"+b.port);var e=unescape(b.fragment||"");if(e.length>0){var f=e.split(","),g=f.shift(),h=f.shift(),i=f.shift(),j=b.scheme+"://"+document.domain+":"+b.port,k=b.scheme+"://"+b.authority,l=g+"/.kr?.kr=xsc&.kv=10.05",m=document.location.toString().split("#")[0],n=l+"#"+escape([j,h,escape(m)].join(","));if("undefined"!=typeof ActiveXObject){c=new ActiveXObject("htmlfile"),c.open();try{c.parentWindow.opener=window}catch(o){a&&(c.domain=a),c.parentWindow.opener=window}c.write("<html>"),c.write("<body>"),a&&c.write("<script>CollectGarbage();document.domain='"+a+"';</script>"),c.write('<iframe src="'+l+'"></iframe>'),c.write("</body>"),c.write("</html>"),c.close();var p=c.body.lastChild,q=c.parentWindow,r=parent,s=r.parent.postMessage0;"undefined"!=typeof s&&(p.onload=function(){var a=p.contentWindow;a.location.replace(n),s.attach(r,g,i,q,a,l)})}else{var p=document.createElement("iframe");p.src=n,document.body.appendChild(p);var q=window,t=p.contentWindow,r=parent,s=r.parent.postMessage0;"undefined"!=typeof s&&s.attach(r,g,i,q,t,l)}}window.onunload=function(){try{var a=window.parent.parent.postMessage0;"undefined"!=typeof a&&a.detach(r)}catch(b){}"undefined"!=typeof c&&(c.parentWindow.opener=null,c.open(),c.close(),c=null,CollectGarbage())}};n.__init__=function(a,b){var c=w.toString();a.URI=URI,a.browser=browser,b||(b=""),a.setTimeout("("+c+")('"+b+"')",0)},n.bridgeURL=!1,n.detach=function(a){for(var b=l(a),c=0;c<v.length;c++)v[c]==b&&v.splice(c,1);b.detach()},window!=top&&(u.parent=new a,o());for(var x=document.getElementsByTagName("meta"),y=0;y<x.length;y++)if("kaazing:postMessage"===x[y].name){if("immediate"==x[y].content){var z=function(){for(var a=document.getElementsByTagName("iframe"),b=0;b<a.length;b++){var c=a[b];if("immediate"==c.style.KaaPostMessage){c.style.KaaPostMessage="none";var e=m(c);d(e,c.contentWindow)}}setTimeout(z,20)};setTimeout(z,20)}break}for(var y=0;y<x.length;y++)if("kaazing:postMessagePrefix"===x[y].name){var A=x[y].content;null!=A&&A.length>0&&("/"!=A.charAt(0)&&(A="/"+A),s=A)}return setTimeout(k,20),n}();!function(){function a(c,d,e,f,h){var i;try{i=f.contentWindow}catch(j){return null!=h&&clearTimeout(h),void g(e)}var k=i.document;if(!k)return void setTimeout(function(){a(c,d,e,f,h)},20);switch(k.readyState){case"interactive":case"complete":null!=h&&clearTimeout(h),setTimeout(function(){b(c,d,e,f)},0);break;default:setTimeout(function(){a(c,d,e,f,h)},20)}}function b(a,b,c,d){function e(){try{var d=f.document,i="complete"==d.readyState?4:3,j=f.currentNodeIndex||0;switch(f._readyState){case 2:for(var k=[],l=h.firstChild;l;l=l.nextSibling)k.push(l.data);var n=m(k.join(""));if(null!==n){f._readyState=i;var o=[];for(var q in z)if("string"==typeof q){var s=n.getResponseHeader(q);null!=s&&o.push([q,s])}p(a,b,c,o,n.status,n.statusText);for(var t=n.endOfHeadersAt;t>h.childNodes[j].length;)t-=h.childNodes[j].length,j++;f.oldNodeCount=j,f.oldNodeDataLength=t}break;case 3:case 4:f._readyState=i}if(f._readyState>=3){var u=h.childNodes[j],v="undefined"!=typeof u?u.data:"",w=h.childNodes.length,x=f.oldNodeCount||1,y=f.oldNodeDataLength||0,A=v.length,B="";if((A>y||4==i)&&(B+=v.slice(y),f.oldNodeDataLength=A),w>x){do j++,B+=h.childNodes[j].data;while(w-1>j);f.currentNodeIndex=j,f.oldNodeDataLength=h.childNodes[j].data.length,f.oldNodeCount=w}(B.length>0||4===i)&&postMessage0(a,["p",c,i,r(B.length,8),B].join(""),b)}4!=f._readyState?f.setTimeout(e,50):g(c)}catch(C){g(c)}}var f=d.contentWindow,h=f.document.body.childNodes[0];f._progressAt=0,f._readyState=2,h&&f.setTimeout(e,0)}function c(a){if(a.source==parent){var b=a.data;if(b.length>=9){var c=0,d=b.substring(c,c+=1),f=b.substring(c,c+=8);switch(d){case"s":for(var g=q(b.substring(c,c+=1)),j=b.substring(c,c+=g),k=q(b.substring(c,c+=4)),l=b.substring(c,c+=k),m={},n=q(b.substring(c,c+=4)),o=0;n>o;o++){var p=q(b.substring(c,c+=4)),r=b.substring(c,c+=p),s=q(b.substring(c,c+=4)),t=b.substring(c,c+=s);m[r]=t}var u=q(b.substring(c,c+=8)),v=b.substring(c,c+=u),w=q(b.substring(c,c+=4)),x="t"==b.substring(c,c+=1),y=a.origin,z=new URI(y);if(void 0===z.port&&"null"!==y){var A={http:80,https:443};z.port=A[z.scheme],z.authority=z.host+":"+z.port,y=z.scheme+"://"+z.authority}"file"===z.scheme&&(y="null"),e(a.source,y,f,j,l,m,v,w,x);break;case"a":h(f);break;case"d":i(f)}}}}function d(){try{return new XMLHttpRequest}catch(a){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(b){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(c){}throw new Error("Unable to create XHR")}function e(a,b,c,e,g,h,i,j,k){var l=!w[e];if(!l){for(var m in h)l||"string"!=typeof m||(l=!x[m]);if(!l&&"POST"==e){var o=h["Content-Type"];if(void 0!==o){var p=o.indexOf(";");-1!=p&&(o=o.substring(0,p)),l=!y[o]}}}if(l){var q=d(),r=g,s=[];s.push(-1==g.indexOf("?")?"?":"&"),s.push(".km=O"),q.open("POST",g+s.join(""),!0),q.setRequestHeader("X-Origin",b),q.setRequestHeader("Access-Control-Request-Method",e);var t=[];for(var m in h)"string"!=typeof m||x[m]||t.push(m);q.setRequestHeader("Access-Control-Request-Headers",t.join(",")),q.onreadystatechange=function(){n(a,b,c,e,g,h,i,j,k,q)},q.send("")}else f(a,b,c,e,g,h,i,j,k)}function f(a,b,c,d,e,f,g,h,i){"ie"==browser&&""===g&&i?(navigator.userAgent.indexOf("MSIE 9")>=0||navigator.userAgent.indexOf("MSIE 8")>=0)&&"undefined"!=typeof XDomainRequest?l(a,b,c,d,e,f,g,h):j(a,b,c,d,e,h):k(a,b,c,d,e,f,g,h,i)}function g(a){var b=u[a];void 0!==b&&b.onError(),i(a)}function h(a){var b=u[a];if(void 0!==b)switch(b.type){case"iframe":b.transport.src="about:blank";break;case"xhr":b.transport.abort()}}function i(a){var b=u[a];if(void 0!==b)switch(b.type){case"iframe":var c=b.transport;c.parentNode.removeChild(c)}delete u[a]}function j(b,c,d,e,f,h){if("GET"!==e)throw new Error("Method not supported for streaming response: "+e);var i=new URI(f),j=".ko="+escape(c);void 0!==i.query?i.query+="&"+j:i.query=j;var k=u[d]||{},l="iframe"==k.type?k.transport:null;null!==l&&l.parentNode.removeChild(l),l=v.createElement("iframe"),l.setAttribute("src",i.toString()),v.body.appendChild(l);var m=setTimeout(function(){g(d)},5e3);setTimeout(function(){a(b,c,d,l,m)},20),u[d]={type:"iframe",transport:l,onError:function(){postMessage0(b,["e",d].join(""),c)}}}function k(a,b,c,e,f,g,h,i,j){function k(){var d="",e=null;if(l.readyState>=3)if(200==l.status)switch(e=l.responseText,n){case 2:var f=m(e);if(null!==f){n=l.readyState;var g=[];for(var h in z)if("string"==typeof h){var i=f.getResponseHeader(h);null!=i&&g.push([h,i])}p(a,b,c,g,f.status,f.statusText),o=e.length-f.responseText.length}break;case 3:case 4:n=l.readyState}else{var g=[];p(a,b,c,g,l.status,l.statusText)}if(n>2){if(null!==e){var j=e.length;j>o&&(d=e.slice(o),o=j)}postMessage0(a,["p",c,n,r(d.length,8),d].join(""),b)}t&&4>n&&(q=setTimeout(k,20))}var l=d();u[c]={type:"xhr",transport:l};var n=2,o=0,q=null,s="ie"===browser?4:3,t=j&&"opera"==browser,v=!1;l.open(e,f,!0);for(var w in g)"string"==typeof w&&(l.setRequestHeader(w,g[w]),"Content-Type"==w&&0==g[w].indexOf("text/plain")&&(v=!0));l.setRequestHeader("X-Origin",b),l.onreadystatechange=function(){var a=l.readyState;a>=s&&k(),4==a&&null!==q&&clearTimeout(q)},"ie"!=browser&&(l.onerror=function(){postMessage0(a,["e",c].join(""),b)}),l.sendAsBinary&&!v?(l.setRequestHeader("Content-Type","application/octet-stream"),l.sendAsBinary(h)):l.send(h)}function l(a,b,c,d,e,f,h,i){-1==e.indexOf(".kf=200")&&(e+="&.kf=200&.kp=2048"),e+="&.kac=ex&.kct=application/x-message-http";var j=new XDomainRequest;u[c]={type:"xhr",transport:j};var k=2,l=0;j.onprogress=function(){try{if(2==k){var d=j.responseText;l=d.length;var e=m(d);if(null!==e){k=3;var f=[];for(var h in z)if("string"==typeof h){var i=e.getResponseHeader(h);null!=i&&f.push([h,i])}p(a,b,c,f,e.status,e.statusText),l=d.length-e.responseText.length}}var n=j.responseText.length;if(n>l){var o=j.responseText.slice(l);l=n,postMessage0(a,["p",c,k,r(o.length,8),o].join(""),b)}}catch(q){g(c)}},j.onerror=function(){postMessage0(a,["e",c].join(""),b)},j.ontimeout=function(){postMessage0(a,["e",c].join(""),b)},j.onload=function(){k=4;var d="",e=j.responseText.length;e>l&&(d=j.responseText.slice(l),l=e),postMessage0(a,["p",c,k,r(d.length,8),d].join(""),b)};var n=d+" "+e.substring(e.indexOf("/",9),e.indexOf("&.kct"))+" HTTP/1.1\r\nContent-Type: text/plain; charset=windows-1252\r\n\r\n";j.open("POST",e),j.send(n)}function m(a){var b=/(\r\n|\r|\n)/,c=a.match(b);if(!c||c.length<=1)return null;var d=c[1],e=d+d,f=a.indexOf(e)+e.length;if(f<e.length)return null;for(var g=a.indexOf(d)+d.length,h=a.substring(0,g),i=h.match(/HTTP\/1\.\d\s(\d+)\s([^\r\n]+)/),j=a.substring(g,f),k=j.split(d),l={},m=0;m<k.length;m++){var n=k[m].match(/([^\:]+)\:\s?(.*)/);if(n){var o=n[1].replace(/^\s+|\s+$/g,""),p=n[2].replace(/^\s+|\s+$/g,""),q=l[o],r=p;q&&p.length>0&&(r=q.concat(",").concat(p)),l[n[1]]=r}}var s={};return s.status=parseInt(i[1]),s.statusText=i[2],s.endOfHeadersAt=f,s.responseText=a.substring(f),s.getResponseHeader=function(a){return l[a]},s}function n(a,b,c,d,e,g,h,i,j,k){switch(k.readyState){case 4:var l=m(k.responseText);if(200==l.status&&"pass"==o(l,b)){for(var n=(l.getResponseHeader("Access-Control-Allow-Methods")||"").split(","),p=!1,q=0;q<n.length;q++)if(n[q]==d){p=!0;break}if(p){var r=(l.getResponseHeader("Access-Control-Allow-Headers")||"").split(","),s=!0;for(var t in g)if("string"==typeof t){var u=x[t];if(!u)for(var q=0;q<r.length;q++)if(r[q]==t){u=!0;break}if(s=u,!s)break}if(s)return void f(a,b,c,d,e,g,h,i,j)}}postMessage0(a,["e",c].join(""),b)}}function o(a,b){var c=a.getResponseHeader("Access-Control-Allow-Origin");if(c!=b)return"fail";var d=a.getResponseHeader("Access-Control-Allow-Credentials");return"true"!=d?"fail":"pass"}function p(a,b,c,d,e,f){var g=["r",c];g.push(r(d.length,2));for(var h=0;h<d.length;h++){var i=d[h];g.push(r(i[0].length,4)),g.push(i[0]),g.push(r(i[1].length,4)),g.push(i[1])}g.push(r(e,4)),g.push(r(f.length,2)),g.push(f),postMessage0(a,g.join(""),b)}function q(a){return parseInt(a,16)}function r(a,b){var c=a.toString(16),d=[];for(b-=c.length;b-- >0;)d.push("0");return d.push(c),d.join("")}var s=new URI("ie"==browser?document.URL:location.href),t={http:80,https:443};null==s.port&&(s.port=t[s.scheme],s.authority=s.host+":"+s.port);var u={},v,w={GET:1,POST:1},x={Accept:1,"Accept-Language":1,"Content-Type":1,Authorization:1,"X-WebSocket-Protocol":1,"X-WebSocket-Extensions":1,"X-WebSocket-Version":1,"X-Accept-Commands":1,"X-Sequence-No":1},y={"application/x-www-form-url-encoded":1,"multipart/form-data":1,"text/plain":1},z={Location:1,"Cache-Control":1,"Content-Language":1,"Content-Type":1,Expires:1,"Last-Modified":1,Pragma:1,"WWW-Authenticate":1,"X-WebSocket-Protocol":1,"X-WebSocket-Extensions":1,"X-WebSocket-Version":1,"X-Accept-Commands":1,"X-Idle-Timeout":1};window.onload=function(){"ie"==browser&&(v=new ActiveXObject("htmlfile"),v.open(),v.write("<html>"),v.write("<body>"),v.write("</body>"),v.write("<html>"),v.close()),postMessage0(parent,"I","*")},window.onbeforeonload=function(){for(;document.body.firstChild;){var a=document.body.firstChild;a.src="about:blank"}},window.onunload=function(){"ie"==browser&&(v.open(),v.close(),v=null,CollectGarbage())},window.addEventListener("message",c,!1)}();